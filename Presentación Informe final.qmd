---
format:
  revealjs:
    title-slide: false
    theme: multinivel.scss
    incremental: true 
    slideNumber: true
    auto-stretch: false
    transition: fade
    transition-speed: slow
    scrollable: true
    scrollOverflow: true           
    css: estilos.css 
    self-contained: true
editor: source
---

# 

```{r paquetes y modelos}
#| include: false
#| message: false

if (!require("pacman")) install.packages("pacman") # solo la primera vez
pacman::p_load(lme4,
               kableExtra,
               haven,
               car,
               sjmisc,
               sjPlot,
               stargazer,
               ggplot2, # gráficos
               dplyr, # manipulacion de datos
               equatiomatic, knitr, kableExtra, htmltools) # paquetes a cargar


casen_educ <- readRDS("output/casen_educ.rds")

# ---- centrados --------------------------------------------------------------
casen_educ <- casen_educ %>%                 # CMC nivel-1
  group_by(comuna) %>%
  mutate(
    mean_nse_comuna = mean(nse_numerico, na.rm = TRUE),
    nse_cmc         = nse_numerico - mean_nse_comuna
  ) %>% ungroup() %>%                        # GMC nivel-2
  mutate(
    prop_empleo_gmc = prop_empleo - mean(prop_empleo, na.rm = TRUE),
    n_escuelas_gmc  = n_escuelas  - mean(n_escuelas,  na.rm = TRUE)
  )

# ---- modelos ----------------------------------------------------------------
m0    <- lmer(esc ~ 1 + (1 | comuna), data = casen_educ)
m1    <- lmer(esc ~ female + nse_cmc + part_social_num + (1|comuna), data = casen_educ)
m2    <- lmer(esc ~ prop_empleo_gmc + n_escuelas_gmc + (1|comuna),    data = casen_educ)
m3    <- lmer(esc ~ female + nse_cmc + part_social_num +
                     prop_empleo_gmc + n_escuelas_gmc + (1|comuna),   data = casen_educ)
m4    <- lmer(esc ~ female + nse_cmc + part_social_num +
                     prop_empleo_gmc + n_escuelas_gmc +
                     (1 + nse_cmc | comuna),                          data = casen_educ)
m5_H6 <- lmer(esc ~ nse_cmc * prop_empleo_gmc +
                     part_social_num + n_escuelas_gmc + female +
                     (1 + nse_cmc | comuna),                          data = casen_educ)




```

:::::: columns
::: {.column width="20%"}
:::

:::: {.column .column-right width="80%"}
## Actitudes Económicas y Confianza Institucional en America Latina: Un Análisis Multinivel Preliminar

------------------------------------------------------------------------

**Yerkho Nuñez, Dorian Ñanco, Morgan Salazar Análisis de datos multinivel - 2025**

::: {.red2 .medium}
**Departamento de Sociología, Universidad de Chile**
:::

Santiago, 25 de Junio de 2025
::::

[Github repo](link%20al%20repo)
::::::

::: notes
Aquí mis notas
:::

# Introducción

-   **Problema/Objeto de estudio:**

    | Uno de los componentes fundamentales de la sociedad son las instituciones, cada una cumpliendo un rol específico según las necesidades de la población y los problemas emergentes, con el fin de asegurar el bienestar colectivo (North, 1993). La efectividad y legitimidad de estas instituciones no solo dependen de sus acciones formales, sino también de la percepción pública y las nociones predominantes sobre cómo deben enfrentar los problemas, sus causas y soluciones. Un ejemplo claro es la desconfianza ciudadana hacia las fuerzas policiales para combatir la delincuencia, lo que puede llevar a que los individuos prefieran la autodefensa como solución a problemas de seguridad, como la invasión de la propiedad privada (Kahan, 2001; Smulovitz & Peruzzotti, 2000).

------------------------------------------------------------------------

-   **Factores asociados L1:** Confianza en instituciones, Actitudes Pro- mercado, Variables de control.

    Se utiliza la encuesta Latinobarómetro 2023. Los datos fueron procesados para seleccionar las variables de interés, tratar valores perdidos y recodificar ítems para la construcción de escalas e índices. Las Variables expresan la confianza que se tienen ante instituciones publicas y poderes del estado bajo el contexto del modelo neoliberal siendo parte de la base datos la division por sexo y edad siendo las que conforman las variables de control.

-   **Factores asociados L2:** País y Porcentaje de Gasto Social en el PIB, Indice de Gini

    > Las Variables se componen por cada Pais del contiente junto con el gasto social que realizan anualmente componiendo esta variable el indice de Gini y el PIB per capita.

##  {data-background-color="#FF0000"}

::: {.center .middle}
¿Cómo se asocian las actitudes individuales pro-mercado (divididas en dimensiones como la creencia en la primacía del mercado, la confianza en el sector privado y el apoyo a la apertura económica) con la confianza en instituciones gubernamentales clave (Poder Judicial, Gobierno, Congreso, Policía) en los ciudadanos de diversos países latinoamericanos, y **qué proporción de la varianza en esta confianza se debe a diferencias entre los países?**
:::

# Hipótesis:

**Nivel 1:**

$H_1$: (Nivel Individual):** Una mayor adhesión individual a la "Creencia en la Primacía y Eficiencia del Mercado" se asociará positivamente con la confianza en el Poder Judicial y la Policía. *(Nota: Dada la muy baja fiabilidad del índice (Alfa=0.246), esta hipótesis se explorará utilizando ítems individuales en el informe final).*
$H_2$: (Nivel Individual):** Una mayor "Confianza individual en el Sector Privado y Actores Económicos" se asociará positivamente con la confianza en el Gobierno.

$H_3$:(Nivel Individual):** Un mayor "Apoyo individual a la Apertura Económica e Integración Global" se asociará positivamente con la confianza en el Congreso.
**Nivel 2:**

$H_4$: Existirá una varianza significativa en la confianza en el Poder Judicial, Gobierno, Congreso y Policía atribuible a las diferencias entre países latinoamericanos (ICC \> 0.05).

$H_5$:En países con menor desigualdad (medida por el índice de Gini), la relación positiva entre la confianza individual en el mercado y la confianza en las instituciones estatales es más fuerte

------------------------------------------------------------------------


# Metodología {data-background-color="#FF0000"}

## Datos

\[Se utilizó la base de datos del Latinobarometro del año 2023, tiene un diseño divido por país, sexo y edad. Para el analisis se uso una cantidad de 13.157 personas dividido en 17 paises de America Latina.\]

## Variables

```{r carga_datos_latinobarometro, eval=TRUE, include=FALSE}
# 1. Carga de Librerias
if (!require("pacman")) install.packages("pacman")
pacman::p_load(lme4, 
               haven, 
               stargazer, 
               ggplot2, 
               texreg, 
               dplyr, 
               psych, 
               kableExtra, 
               ggeffects, 
               reghelper, 
               gtsummary,
               rnaturalearth,
               rnaturalearthdata,
               sf,
               ggdist,
               patchwork)

# 2 Carga de Base de Datos
base_raw <- haven::read_sav("input/data/latinobarometro_2023.sav", user_na = TRUE) 

# 3. Seleccion de Variables Nivel 1
base_proc <- base_raw %>% 
  select(
    # ID Agregada
    pais = IDENPA, 
    # Nivel 1, Control
    edad = EDAD, 
    sexo = SEXO, 
    niv_educ = REEEDUC.1, 
    esc_pol = P16ST,
    # Nivel 1, VD
    conf_congreso = P13ST.D,
    conf_gobierno = P13ST.E, 
    conf_judicial = P13ST.F,
    # Nivel 1, Indice Agentes Economicos
    conf_cias_nac = P14ST.B,
    conf_cias_int = P14ST.E,
    conf_bancos = P14ST.F,
    # Nivel 1, Desigualdad
    neol_acept_des = P61ST,
    neol_dist_ing = P17ST,
    # Nivel 1, Sistema unico
    neol_unico = P54ST.B, 
  )

)

### # 4. Adición de Variables Nivel 2
datos_pais <- data.frame(
  # ID Agregada
  pais = c(32, 68, 76, 152, 170, 188, 218, 222, 320, 340, 484, 558, 591, 600, 858, 862, 214), 
  # Etiqueta Agregada
  nombrepais = c("Argentina", "Bolivia", "Brasil", "Chile", "Colombia", "Costa Rica", "Ecuador", "El Salvador", 
                 "Guatemala", "Honduras", "México", "Nicaragua", "Panamá", "Paraguay", "Uruguay", "Venezuela", "Rep. Dominicana"),
  # Nivel 2, % de Gasto Social en el PIB
  gasto_social= c(37.84, 36.00, 45.31, 27.40, 35.45, 18.51, 39.45, 30.38, 13.72, 26.10, 28.59, 26.06, 21.49, 21.48, 30.52, 34.37, 19.13), # Datos extraidos de https://datosmacro.expansion.com/estado/gasto?anio=2023
  # Nivel 2, Desigualdad
  gini = c(40.7, 40.9, 52.0, 43.0, 54.8, 46.7, 44.6, 38.8, 48.3, 48.2, 43.5, 46.2, 48.9, 45.1, 40.6, 44.7, 37.0), #Datos de Guatemala y Nicaragua de 2014, Venezuela de 2006 # Datos extraidos de https://datosmacro.expansion.com/demografia/indice-gini
  # Nivel 2. Control
  pib_per_capita = c(14187.48, 3686.28, 10294.87, 17067.81, 6947.36, 16942.03, 6609.8, 5391.07, 5762.82, 3231.66, 13790.02, 2612.87, 18686.41, 6276.35, 22797.81, NA, 10717.63) 
  )
)

### 5. Merge de bases

base_proc <- left_join(base_proc, datos_pais, by = "pais")

  )
)
invisible(NULL)

```

## Métodos

Para el análisis estadístico se uso una metodología multinivel para asi poder observar la confianza en instituciones gubernamentales según cada pais, el modelo economico de cada uno de estos junto a divisiones de sexo y edad.

Se uso Rstudio para lograr el análisis de datos, se uso

El análisis de datos se realizó en Rstudio, utilizando \_lmer\_ para la construcción de los modelos, \_sjPlot\_ para la visualización de los datos y \_summary tools\_ para generar descriptivos univariados

Se estimaron un total de 3 modelos, siguientes modelos:

## Modelo nulo

$$

\text{conf}_{ij} = \gamma_{00} + u_{0j} + r_{ij}

$$


## Modelo 1 con variables independientes individuales

$$
\text{conf}_{ij} = \beta_{0j} + \beta_{1j} \cdot \text{neolib}_{ij} + \beta_{2j} \cdot \text{edad}_{ij} + \beta_{3j} \cdot \text{genero}_{ij} + \beta_{4j} \cdot \text{educ}_{ij} + \beta_{5j} \cdot \text{ingreso}_{ij} + \beta_{6j} \cdot \text{ideo}_{ij} + r_{ij} 
$$

## Modelo 2 con variables independientes contextuales

$$
\text{esc}_{ij} \;=\; \gamma_{00}
+ \gamma_{01}\,\text{prop_empleo_gmc}
+ \gamma_{02}\,\text{n_escuelas_gmc}
+ u_{0\text{comuna}}
+ r_{ij}
$$

## Modelo 3 con variables independiente individual y grupal

:::: {style="font-size:85%"}
::: {style="overflow-x: auto; white-space: nowrap;"}
$$
\text{conf}_{ij} = \gamma_{00} 
+ \gamma_{10} \cdot \text{neolib}_{ij}
+ \gamma_{20} \cdot \text{edad}_{ij}
+ \gamma_{30} \cdot \text{genero}_{ij}
+ \gamma_{40} \cdot \text{educ}_{ij}
+ \gamma_{01} \cdot \text{GINI}_j
+ \gamma_{02} \cdot \text{gasto}_j
+ u_{0j} 
+ r_{ij}
$$
:::
::::

# Resultados {data-background-color="#FF0000"}

## Descriptivos

Scatterplot: relación entre promedio comunal de escolaridad y tasa de empleo

```{r Scatterplot}
casen_educ %>%
  group_by(comuna) %>%
  summarise(
    esc_prom = mean(esc, na.rm = TRUE),
    prop_empleo = first(prop_empleo)
  ) %>%
  ggplot(aes(x = prop_empleo, y = esc_prom)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "steelblue") +
  labs(
    title = "Relación entre tasa de empleo comunal y escolaridad promedio",
    x = "Tasa de empleo (proporción)",
    y = "Años promedio de escolaridad"
  ) +
  theme_minimal()
```

------------------------------------------------------------------------

## Boxplot

escolaridad individual según cuartiles de escuelas comunales

```{r Boxplot}
casen_educ %>%
  mutate(
    cuartil_escuelas = ntile(n_escuelas, 4)  # divide en 4 cuartiles
  ) %>%
  ggplot(aes(x = factor(cuartil_escuelas), y = esc)) +
  geom_boxplot(fill = "lightgray", color = "black") +
  labs(
    title = "Distribución de escolaridad según cantidad de escuelas en la comuna",
    x = "Cuartil de cantidad de escuelas",
    y = "Años de escolaridad"
  ) +
  theme_minimal()
```

\`

## Modelos

```{r tabla_modelos, echo=FALSE, results='asis'}
library(sjPlot)

# 1. Genera la tabla SIN imprimirla
html_tab <- tab_model(
  m0, m1, m2, m3, m4, m5_H6,
  show.ci  = FALSE,
  show.se  = TRUE,
  p.style  = "stars",
  digits   = 3,
  dv.labels = c(
    "Nulo (ICC)", "L1 (centrado)", "L2 (centrado)",
    "L1 + L2", "+ Pend. NSE", "+ Interacción H6"
  ),
  file = NA          # ← devuelve la lista, no la imprime
)

# 2. Compone la salida (solo UNA vez)
salida <- paste0(
  "<style>", html_tab$page.style, "</style>",
  '<div class="hscroll small-table">', html_tab$page.content, "</div>"
)

knitr::asis_output(salida)
invisible(NULL)      # evita ecos adicionales
```

------------------------------------------------------------------------

## Test de devianza

```{r test de devianza}
#| label: lrt-table
#| echo: false
#| results: asis
#| warning: false
#| message: false


## 1 ─ LRT ----------------------------------------------------------------------
lrt_raw <- anova(m3, m4) |>
  as.data.frame() |>
  tibble::rownames_to_column("modelo") |>
  mutate(modelo = recode(modelo,
                         m3 = "sin&nbsp;pendiente",
                         m4 = "con&nbsp;pendiente"))

row_lrt <- tibble(
  modelo = "LRT", npar = NA, AIC = NA, BIC = NA, logLik = NA,
  LRT = lrt_raw$Chisq[2], gl = lrt_raw$Df[2],
  p = lrt_raw$`Pr(>Chisq)`[2]
)

tabla_lrt <- bind_rows(
  select(lrt_raw, modelo, npar, AIC, BIC, logLik),
  row_lrt
)

## 2 ─ kable en HTML ------------------------------------------------------------
tbl_html <- kable(tabla_lrt, "html", digits = 3, escape = FALSE,
                  caption = "¿La pendiente aleatoria de NSE mejora el ajuste?") |>
  kable_styling(full_width = FALSE,
                bootstrap_options = c("striped", "hover", "condensed"),
                font_size = 15) |>          # ← TAMAÑO FUENTE (sube o baja)
  add_header_above(c(" " = 5, "Likelihood-ratio test" = 3)) |>
  add_footnote(
    "χ² significativo (p < 0.001) ⇒ conviene dejar la pendiente de NSE como aleatoria",
    notation = "none"
  )

## 3 ─ contenedor centrado con scroll si hace falta ----------------------------
scroll_box <- div(
  style = "
    max-width: 1000px;      /* cambia este ancho si lo necesitas */
    margin: 0 auto;         /* centra la tabla */
    overflow-x: auto;       /* barra horizontal si se pasa de 1000 px */
  ",
  HTML(tbl_html)
)

knitr::asis_output(as.character(scroll_box))
```

------------------------------------------------------------------------

## Interacción

::::: columns
::: {.column width="60%"}
```{r }
library(sjPlot)
library(ggplot2)

p_h6 <- plot_model(
  m5_H6,
  type  = "int",
  terms = c("nse_cmc", "prop_empleo_gmc")
) +
  labs(
    title  = "Interacción H6: NSE individual × Tasa de empleo comunal",
    x      = "NSE centrado en la comuna (CMC)",
    y      = "Años esperados de escolaridad",
    colour = "Tasa de empleo comunal\n(−1 DE / Media / +1 DE)"
  ) +
  theme_minimal(base_size = 12)

print(p_h6)      # <- aseguras la impresión  
```
:::

::: {.column width="40%"}
[La interacción muestra que el efecto del nivel socioeconómico sobre la escolaridad varía según la tasa de empleo comunal. En comunas con más empleo (azul), el NSE tiene un impacto mayor sobre los años de escolaridad, mientras que en comunas con menos empleo (roja), su efecto es más débil. Esto confirma que los recursos familiares rinden más en contextos laborales favorables, ampliando así las desigualdades educativas.]{style="font-size: 80%;"}
:::
:::::

# **Observaciones influyentes**

```{r Observaciones influyentes}
#| include: false
library(influence.ME)  # Cook's distance por grupo
library(dplyr)         # manipulación de datos
library(forcats)       # fct_drop
library(sjPlot)        # tab_model
library(broom.mixed)   # tidy() para lmer

casen_educ_cen <- readRDS("output/casen_educ_cen.rds") %>%
  filter(!is.na(comuna)) %>%                # asegura no haber NAs
  mutate(comuna = as.factor(comuna))        # comuna como factor

stopifnot(nlevels(casen_educ_cen$comuna) == 32)  # debe haber 32 comunas

# ---------------------------------------------------------------
# 1. Modelo original (m4) ---------------------------------------
# ---------------------------------------------------------------
m4 <- lmer(
  esc ~ female + nse_cmc + part_social_num +
    prop_empleo_gmc + n_escuelas_gmc +
    (1 + nse_cmc | comuna),
  data = casen_educ_cen
)

# ---------------------------------------------------------------
# 2. Cook’s Distance por comuna ---------------------------------
# ---------------------------------------------------------------
infl_m4   <- influence(m4, group = "comuna")
cook_vals <- cooks.distance(infl_m4, sort = FALSE)

# Añadir nombres de comunas si faltan
if (is.null(names(cook_vals)) || length(names(cook_vals)) == 0) {
  names(cook_vals) <- levels(casen_educ_cen$comuna)
}

# Punto de corte 4/k
k      <- nlevels(casen_educ_cen$comuna)    # 32
cutoff <- 4 / k                             # ≈ 0.125

# Comunas influyentes (Cook > cutoff, ignorando NA)
influentes <- names(cook_vals)[!is.na(cook_vals) & cook_vals > cutoff]

cat("Comunas influyentes (Cook >", round(cutoff, 3), "):\n")
                           # ej. "Vitacura" "Santiago"


```

```{r Gráfico de Cook}
# ---------------------------------------------------------------
# 3. Gráfico de Cook --------------------------------------------
# ---------------------------------------------------------------
plot(
  infl_m4, which = "cook",
  cutoff  = cutoff, sort = TRUE,
  xlab    = "Cook's distance", ylab = "Comuna",
  main    = "Distancia de Cook – Influencia por comuna (modelo m4)"
)

```

------------------------------------------------------------------------

```{r}
#| include: false
# ---------------------------------------------------------------
# 4. Modelo recortado (m4_trim) ---------------------------------
# ---------------------------------------------------------------
casen_trim <- casen_educ_cen %>%
  filter(!comuna %in% influentes) %>%        # excluir influyentes
  mutate(comuna = fct_drop(comuna))          # quitar niveles vacíos

m4_trim <- lmer(
  esc ~ female + nse_cmc + part_social_num +
    prop_empleo_gmc + n_escuelas_gmc +
    (1 + nse_cmc | comuna),
  data  = casen_trim,
  REML  = FALSE
)

cat("\nNúmero de comunas en m4_trim:\n")
print(summary(m4_trim)$ngrps)                # debería ser 30


```

```{r}
tab_model(
  m4, m4_trim,
  dv.labels = c("Modelo original", "Sin comunas influyentes"),
  show.ci   = FALSE, p.style = "stars", digits = 3
)
```

# Conclusiones {data-background-color="#FF0000"}

![Modelo teórico con resultados](input/img/r_Años_de_escolaridad.png){fig-align="center" width="830"}

## Referencias

Agencia de Calidad de la Educación. (2015, agosto). Evolución de las brechas socioeconómicas de rendimiento en pruebas SIMCE. División de Estudios, Agencia de Calidad de la Educación.

Andréu, J. (2011). El análisis multinivel: una revisión actualizada en el ámbito sociológico. Metodología de Encuestas, 13, 161–176.

Arita, M., Romano, A., García, A., & Félix, F. (2015). Condiciones de vida y bienestar subjetivo en Culiacán, México. Universidad Autónoma de Sinaloa.

Bellei Carvacho, C., Contreras, D., & Valenzuela Barros, J. P. (2008). La agenda pendiente en educación. Profesores, administradores y recursos: propuestas para la nueva arquitectura de la educación chilena. Universidad de Chile.

Bourdieu, P., & Passeron, J. C. (2001). La reproducción. Elementos para una teoría del sistema de enseñanza. Editorial Laia.

Bullones, E. (2022). Gestión educativa en valores para la paz comunitaria. Aula Virtual, 3(6), 150–160.

Canales, A., & de Ibarrola, M. (2022). La segmentación del sistema escolar mexicano: un análisis territorial. Revista Mexicana de Investigación Educativa, 27(94), 1035–1060.

Cimadamore, A. D., & Cattani, A. D. (Coords.). (2008). Producción de pobreza y desigualdad en América Latina. Siglo del Hombre Editores.

Finch, W. H., Bolin, J. E., & Kelley, K. (2019). Multilevel modeling using R. Chapman and Hall/CRC.

Instituto Nacional de Evaluación Educativa. (2011). PIRLS–TIMSS 2011. Estudio Internacional de Progreso en Comprensión Lectora, Matemáticas y Ciencias. Volumen I: Informe español. IEA.<https://www.mecd.gob.es/inee>

Ministerio de Educación de Chile. (2023). Informe de resultados SIMCE y brechas por grupo socioeconómico. Santiago: MINEDUC.

Ministerio de Desarrollo Social y Familia. (2022). Encuesta de Caracterización Socioeconómica Nacional (Casen) 2022. Gobierno de Chile.

OECD. (2021). Education at a Glance: OECD Indicators. OECD Publishing.<https://doi.org/10.1787/b35a14e5-en>

Peláez González, C., & Rodríguez, S. A. (2020). Género, trabajo y educación: Diferencias entre hombres y mujeres en la entrada al primer empleo. Revista Interdisciplinaria de Estudios de Género de El Colegio de México, 6, e494.

Rivas Espinosa, A., & Terra Polanco, V. (2024). Percepciones de niñas y niños sobre su hábitat en contextos urbanos informales. Sociológica (Madrid), 39(1).

Romero, E., Alcaraz, S., & Hernández, M. (2020). Desigualdades educativas y respuesta institucional: Una investigación desde la perspectiva territorial. Profesorado, Revista de Currículum y Formación del Profesorado, 24(1), 1–20.

Soler Mata, J., & Fernández León, R. (2021). La evaluación educativa en España: Tensiones entre la evaluación estandarizada y la evaluación formativa. Revista de Educación, 393, 245–271.

Villalobos, C., & Mardones, S. P. (2022). ¿Quién, cómo y de qué se investiga en un sistema educativo mercantilizado? Un meta-análisis de la investigación sobre política educativa en el Chile post-dictadura (1990–2019). Education Policy Analysis Archives, 30, 160.
